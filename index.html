<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PONG GAME</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.9.0/p5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.9.0/addons/p5.dom.min.js"></script>
    <script src="https://unpkg.com/ml5@0.4.3/dist/ml5.min.js"></script>
    <link rel="stylesheet" href="css/style.css">
</head>
<body style="background-image: url(img/FD.jpg);background-repeat: no-repeat; background-size: 100%;">

<div id="blocToCenter" >
    <div id="Titre">
        <h1 >PONG GAME</h1>
    </div>

    <div id="left">
        <label  id="startGame" class="button">START</label>
        <label  id="pauseGame" class="button">PAUSE</label>
        <label  id="continueGame" style="display: none;" class="button">CONTINUE</label>
        <label id="ML" class="button" onclick="init()">CONTROL WITH HEAD</label>
        <div id="webcam-container"></div>
        <div id="label-container"></div>
    </div>
    <div id="divGame"></div>
    <div id="right">
        <label  id="multijoueur" class="buttonD">MULTIJOUEUR</label>
        <div class="lds-roller" ><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div>
        <input type="text" id="NomPartie" style="display: none;">
        <label  id="CreateGame" style="display: none;" class="buttonD">Create 1v1</label>
        <label  id="CreateGame2v2" style="display: none;" class="buttonD">Create 2v2</label>
        <label  id="JoinGame" style="display: none;" class="buttonD">Join game</label>
    </div>
</div>
</body>

<script src="js/game.js"></script>
<script src="js/game.keycode.js"></script>
<script src="js/game.control.js"></script>
<script src="js/game.display.js"></script>
<script src="js/game.ai.js"></script>
<script src="js/game.conf.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script
        src="https://code.jquery.com/jquery-3.4.1.min.js"
        integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
        crossorigin="anonymous"></script>
<script>
    (function () {
        // début du code isolé
        let multi=true;
        let requestAnimId;
        let initialisation = ()=> {
            // le code de l'initialisation

            //changement d'init pour savoir si IA ou pas
            game.init();


            requestAnimId = window.requestAnimationFrame(main); // premier appel de main au rafraîchissement de la page
            socket.emit('nbreConnection');
        };
        let main = ()=> {
            // le code du jeu
            game.clearLayer(game.playersBallLayer);
            game.movePlayers();
            //envoyer ça position
            if((game.playerOne.goDown || game.playerOne.goUp)&&(game.playerTwo.IdSocket!=='')){
                socket
                    .emit('Position',{
                        'Destinataire':game.playerTwo.IdSocket,
                        'Position':game.playerOne.sprite.posY
                    });
                //console.log(game.playerOne.goDown , game.playerOne.goUp);
            }
            game.displayPlayers();
            game.moveBall();
            if ( game.playerOne.service)
                socket
                    .emit('balle',{
                        'Destinataire':game.playerTwo.IdSocket,
                        'Balle':game.ball
                    });
            if ( game.ball.inGame ){
                game.lostBall();

            }


            if (game.playerTwo.ai)
                game.ai.move();
            game.collideBallWithPlayersAndAction();
            requestAnimId = window.requestAnimationFrame(main); // rappel de main au prochain rafraîchissement de la page
        };
        window.onload = initialisation; // appel de la fonction initialisation au chargement de la page
        // fin du code isolé

    })();
</script>
<script>
    let socket=io({
        autoConnect:false
    });
let knowNumberServer=false;
let first=false;

    $('#startGame').click(()=>{
        socket.emit('start');

        //let playerOneCopie=game.playerOne.sprite.posX;
    });
    $('#pauseGame').click(()=>{
        socket.emit('pause');
    });
    $('#continueGame').click(()=>{
        socket.emit('continue');
    });

    SendPosition=()=>{
        socket.emit('Positon',game.playerOne.sprite.posY);
    };
    socket.on('start',()=>{
       // alert('un joueur veut commencer !');
    });
    socket.on('Position',(data)=>{
        //console.log(data);
        game.playerTwo.sprite.posY=data;
    });

    socket.on('balle',(data)=>{
        //console.log(data);
        if(knowNumberServer){
            game.ball.sprite.posX=data.sprite.posX;
            game.ball.sprite.posY=data.sprite.posY;
            game.ball.speed=data.speed;
            console.log('info sur la balle');
        }


    });

    socket.on('nbreConnection',(data)=>{
        console.log('nbre connec',data);
        if(!knowNumberServer && data>1){

            game.playerOne.service = false;
        }else{

            game.playerOne.first = true;
            game.playerOne.service = true;
        }
        knowNumberServer=true;

    })
    socket.on('score',(data)=>{
        game.playerOne.score = data.ScoreP1;
        game.playerTwo.score = data.ScoreP2;
        game.playerOne.service = data.Service;
        game.clearLayer(game.scoreLayer);
        game.displayScore( game.playerOne.score , game.playerTwo.score  );

    }) ;
    socket.on('GameCreated',(data)=>{
        $('#NomPartie').css('display','none');
        $('#CreateGame').css('display','none');
        $('#CreateGame2v2').css('display','none');
        $('#JoinGame').css('display','none');
        game.playerOne.service = true;
        console.log('created',data);
        $('.lds-roller').css('display','inline-block');

        //En attente de l'adversaire
    }) ;
    socket.on('JoinGame',(data)=>{

       console.log('joined',data);
       game.playerTwo.IdSocket=data;
    }) ;
    socket.on('GameAlreadyExist',(data)=>{
        alert('cette partie nexiste pas');
    });
    socket.on('GameNotExist',(data)=>{
        alert('Ce nom de jeu nexiste pas');
    }) ;

    socket.on('AdversaireJoin',(data)=>{
        console.log('l adversaire a rejoint la partie',data);
        $('.lds-roller').css('display','none');
        //attente adversaire... fin
        //gerer le debut du match
        game.playerTwo.IdSocket=data;

    })
    socket.on('reinitGame',()=>{
        game.reinitGame();
    })
    socket.on('continue',()=>{

        game.control.onContinueGameClickButton();
    })
    socket.on('pause',()=>{

        game.control.onPauseGameClickButton();
    })

    //attente de l'adversaire
    //variable service celui qui sert dinne la position de la balle jusqu'au moment ou il perd
    //ameliorer le multi etre sur que le 2 joueurs sont prs
    //voir si ajout d'un menu
    // revoir le CSS
    //Annonce du service
    //gestion sori du jeu disconnect
    //gestion connection a la partie
    //gestion +2 joueurs
</script>
<script>
    $('#multijoueur').click(()=>{
        //ai=false et attendre le joueur
        $('#NomPartie').css('display','inline');
        $('#CreateGame').css('display','inline');
        $('#CreateGame2v2').css('display','inline');
        $('#JoinGame').css('display','inline');
        socket.open();
        game.playerTwo.ai=false;
    });
    $('#pauseGame').click(()=>{
        if (!game.playerTwo.ai)
            socket.emit('pause',game.playerTwo.IdSocket);
    });
    $('#continueGame').click(()=>{
        if (!game.playerTwo.ai)
            socket.emit('continue',game.playerTwo.IdSocket);
    });
    $('#ML').click(()=>{
        init();
    });
    $('#CreateGame2v2').click(()=>{
        console.log($('#NomPartie').val(),$('#NomPartie').val().length);
        ($('#NomPartie').val().length!==0)?
            socket.emit('CreateGame',{
                    NomPartie:$('#NomPartie').val(),
                    ID:socket.id,
                    nbrJoueur:4,
                },
                (data)=>{
                    game.NomPartieMulti=data;
                    if(data!==null) {
                        $('#NomPartie').css('display','none');
                        $('#CreateGame').css('display','none');
                        $('#JoinGame').css('display','none');
                        game.playerOne.service = true;
                        console.log('created',data);
                        $('.lds-roller').css('display','inline-block');
                    }
                }):
            alert('champs vide');
    });
    $('#CreateGame').click(()=>{
        console.log($('#NomPartie').val(),$('#NomPartie').val().length);
        ($('#NomPartie').val().length!==0)?
            socket.emit('CreateGame',{
                    NomPartie:$('#NomPartie').val(),
                    ID:socket.id,
                    nbrJoueur:2,
                },
                (data)=>{
                    game.NomPartieMulti=data;
                    if(data!==null) {
                        $('#NomPartie').css('display','none');
                        $('#CreateGame').css('display','none');
                        $('#JoinGame').css('display','none');
                        game.playerOne.service = true;
                        console.log('created',data);
                        $('.lds-roller').css('display','inline-block');
                    }
                }):
            alert('champs vide');
    });
    $('#JoinGame').click(()=>{
        game.NomPartieMulti=$('#NomPartie').val();
        console.log($('#NomPartie').val(),$('#NomPartie').val().length);
        ($('#NomPartie').val().length!==0)?
            socket.emit('JoinGame',{
                NomPartie:$('#NomPartie').val(),
                ID:socket.id,
            },(data)=>{
                if (data.IdHote.split(' ').length>1){
                    alert(data.IdHote);
                    game.NomPartieMulti=null;
                }else{
                    console.log('place',data.Place);
                    game.playerTwo.IdSocket=data.IdHote;
                    game.playerOne.sprite.posX=conf.PLAYERTWOPOSX;
                    game.playerTwo.sprite.posX=conf.PLAYERONEPOSX;
                    game.playerOne.originalPosition='right';
                    game.playerTwo.originalPosition='left';
                    game.playerOne.service = false;
                    $('#NomPartie').css('display','none');
                    $('#CreateGame').css('display','none');
                    $('#JoinGame').css('display','none');
                }
            }):
            alert('champs vide');

    });


</script>

<script type="text/javascript">
    // More API functions here:
    // https://github.com/googlecreativelab/teachablemachine-community/tree/master/libraries/image

    // the link to your model provided by Teachable Machine export panel
    const URL = "https://teachablemachine.withgoogle.com/models/C0W5bqm9H/";

    let model, webcam, labelContainer, maxPredictions;

    // Load the image model and setup the webcam
    async function init() {
        alert('init');
        const modelURL = URL + "model.json";
        const metadataURL = URL + "metadata.json";

        // load the model and metadata
        // Refer to tmImage.loadFromFiles() in the API to support files from a file picker
        // or files from your local hard drive
        // Note: the pose library adds "tmImage" object to your window (window.tmImage)
        model = await tmImage.load(modelURL, metadataURL);
        maxPredictions = model.getTotalClasses();

        // Convenience function to setup a webcam
        const flip = true; // whether to flip the webcam
        webcam = new tmImage.Webcam(200, 200, flip); // width, height, flip
        await webcam.setup(); // request access to the webcam
        await webcam.play();
        window.requestAnimationFrame(loop);

        // append elements to the DOM
        document.getElementById("webcam-container").appendChild(webcam.canvas);
        labelContainer = document.getElementById("label-container");
        for (let i = 0; i < maxPredictions; i++) { // and class labels
            labelContainer.appendChild(document.createElement("div"));
        }
    }

    async function loop() {
        webcam.update(); // update the webcam frame
        await predict();
        window.requestAnimationFrame(loop);
    }

    // run the webcam image through the image model
    async function predict() {
        // predict can take in an image, video or canvas html element

        const prediction = await model.predict(webcam.canvas);
        for (let i = 0; i < maxPredictions; i++) {

            game.control.controlSystem = "KEYBOARD";
            if (i===0 && prediction[i].probability.toFixed(2)>=0.85){
                game.control.controlSystem = "HEAD";
                game.playerOne.goUp = true;
                game.playerOne.goDown = false;
                console.log( 'haut');
            }
            if (i===1 && prediction[i].probability.toFixed(2)>=0.85){
                game.control.controlSystem = "HEAD";
                game.playerOne.goDown = true;
                game.playerOne.goUp = false;
                console.log( 'bas');
            }
            if (i===2 && prediction[i].probability.toFixed(2)>=0.85){
                game.control.controlSystem = "HEAD";
                game.playerOne.goDown = false;
                game.playerOne.goUp = false;
                console.log( 'milieu');
            }
            (i===0)?  classPrediction =
                " haut : " + prediction[i].probability.toFixed(2):
                (i===1)?
             classPrediction =
                "bas : " + prediction[i].probability.toFixed(2):
                "milieu:"+prediction[i].probability.toFixed(2);

            labelContainer.childNodes[i].innerHTML = classPrediction;
        }
    }
</script>
</html>
